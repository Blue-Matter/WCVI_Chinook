# Methods

The objectives of the case study are to:

1. Develop an operating model in salmonMSE that incorporates life history variability in hatchery release strategies & natural-origin life cycle groups

2. Develop alternative scenarios to compare outcomes with various habitat and hatchery options

3. Develop performance measures and visualization tools to facilitate comparison of various scenarios

## salmonMSE operating model {#sec:om}

The operating model is stochastic and age-structured. Individual scenarios are projected forward in time from a specified starting abundance.

The configuration of the operating model is presented below and organized by life cycle.
Sources for the parameters include the CTC exploitation rate model, Brown et al. Res Doc, as well as the exploitation rate models fitted to various CWT datasets (Appendices \@ref(app:sarita-cwt) and \@ref(app:quinsam-cwt)).

The description below represents the base model, from which subsequent alterations are made.
One hundred simulations were used per scenario, with a projection period of 30 years. 

Summary tables of parameters are presented in Tables \@ref(tab:sarita-om-bio) and \@ref(tab:sarita-om-hatch).

### Spawners

The egg production is calculated from the number of natural origin and hatchery origin spawners. Fecundity is age-specific with fecundity of 3000 at age 3, 3600 at age 4, 4600 at age 5 (Brown et al.).

No fish are mature at age 1.

The fecundity at age 2 was set to half of the value of age 3. Most if not all age 2 spawners are precocious males. 
These spawners can ensure genetic diversity by breeding across brood years. 
Since this is not a sex-specific model, some assumption of fecundity value is needed in order to carry over breeding success for age 2 spawners. Calculations involving spawner composition, including pWILD, PNI, and pHOS are weighted by age class fecundity.

Older age classes more predominantly female, where the proportion female is 0.01 at age 2, 0.1 at age 3, 0.55 at age 4, and 0.8 at age 5 (Brown et al.).

A typical value of 0.8 was used for the relative reproductive success of hatchery spawners (Withler et al.).

### Natural production of juveniles

Egg-fry survival in the natural environment is modeled as a stochastic density-independent parameter, informed by an environment relationship where the fry/adult is predicted from the previous autumn (Figure \@ref(fig:env)).

For the projection, average historical conditions during 2017--2023 were assumed, corresponding to 60% of days when the mean daily discharge exceeded 5 cubic meters per second. The fry/spawner values were then simulated from a lognormal distribution with the mean and standard deviation obtained in Figure \@ref(fig:env).

The egg-fry survival is converted from fry/spawner assuming an average fecundity of 3,900 and a proportion female of 0.4 (Figure \@ref(fig:fry-surv)).

The resulting fry are then divided by life cycle group, which will have different survival rates at age 1 after outmigration (described in Section \@ref(sec:marine-life-stage)). 
95 percent of the fry as assigned as early-smalls and the rest are late-larges.

```{r env, fig.cap="Predicted fry per returning adult (line) and 95% confidence interval (grey band) from a log-linear regression of percent of days in October with mean daily discharge on the Sarita River greater than 5 cubic meters per second. Figure was replicated from Brown et al."}
knitr::include_graphics(here::here("figures/Sarita-fry-survival.png"))
```

```{r fry-surv, fig.cap="Egg to fry survival sampled stochastically across 3 simulations from the environmental variable."}
knitr::include_graphics(here::here("figures/Sarita_envvar.png"))
```

### Hatchery production of juveniles

Target hatchery releases, by release strategy, are specified by the user. The releases in 2023 with 292,853 fed fry and 288,745 traditionals were used as the annual target. 
We evaluate hatchery production strategy of 500,000 annual releases with a 50-50 distribution of fed fry and traditionals.

Release strategies differ in maturity rates, described in Section \@ref(sec:maturity).

The mark rate is assumed to be 1.

The mortality rate is 10 percent shortly after release. Hatchery releases immediately enter the marine life stage.

### Marine life stage and preterminal fishery {#sec:marine-life-stage}

The juvenile marine life stage is represented in the model through a matrix that indexes semestral age and time (2 semesters equals one year). 

In the first half of the year, juveniles are vulnerable to the preterminal fishery. 
The relative vulnerability by age class was stochastically sampled from the posterior distribution in the Sarita exploitation rate model (Appendix \@ref(app:sarita-cwt)) and assumed to be identical for all release strategies and life cycle groups (Figure \@ref(fig:mat-vul)).
A constant, annual harvest rate of 0.35 was used (life cycle model, Table 3.3 of Brown et al.).

In the second half of the year, mature fish are removed from the juvenile abundance matrix, and the remaining juveniles experience natural mortality. 

The natural survival at age 1 natural mortality from obtained from the life cycle model (Table 3.3 of Brown et al.), with 96.9% mortality for both hatchery release strategies. For natural origin fish, age-1 natural mortality is 99.6% for early smalls and 95% for late larges. 

For older fish, the natural mortality is 30% at age 2, 20% at age 3, 10% at age 4 and older, as assumed in the CTC exploitation rate model.

### Maturity and terminal exploitation {#sec:maturity}

CWT escapement indicate that traditionals mature earlier compared to fed fry.
However, the Robertson Creek indicator stock comprises of only traditionals.
Therefore, the approach was to estimate maturity of fed fry and traditionals from the Quinsam (northern Strait of Georgia) stock, and apply the ratio of differences to the Robertson traditionals to arrive at a hypothesized maturity function for Sarita fed fry (Appendix \@ref(app:quinsam-cwt)).

In the CWT exploitation rate model, maturity is estimated for each brood year. 
For the operating model, the maturity was stochastically sampled from the posterior and averaged across the most recent 6 complete brood years (2013--2018, Figure \@ref(fig:mat-vul)).

It is assumed that both natural-origin life cycle groups have the maturity function of fed fry.

The age structure of the return is represented separately from the juveniles. 
The return are only present in the second half of the year and are vulnerable to the terminal fishery.

The relative vulnerability by age class was stochastically sampled from the posterior distribution in the Sarita exploitation rate model (Appendix \@ref(app:sarita-cwt)) and assumed to be identical for all release strategies and life cycle groups (Figure \@ref(fig:mat-vul)).

An annual catch target of 1,000 fish for the terminal fishery which represents the mark-selective ESSR fishery. 

The simplest assumption of no release mortality was used. Therefore, the realized ESSR exploitation rate applies to hatchery-origin fish only. Natural-origin fish experience no additional mortality.

```{r mat-vul, out.width="4in", fig.cap="Maturity by hatchery release strategy and fishery vulnerability at age (identical for all fish) in the operating model. Natural-origin fish have the same maturity as fed fry."}
knitr::include_graphics(here::here("figures/SMSE/maturity_vul.png"))
```

### Escapement and broodtake

After the terminal fishery, the escapement is represented in a third matrix.
Each year, an additional 100 hatchery strays, external to the system, also return. 
It is assumed that they are unmarked.
The age proportion of strays correspond to values observed in the Sarita CWT for traditionals in 2018, assuming it is representative of strays from adjacent systems (11 percent at age 2, 16% at age 3, 69% at age 4, and 4% at age 5).

Additional mortality can be applied en-route to spawning grounds and the hatchery, but currently en-route survival is one.

The number of spawners is the escapement after brood removals.
100 percent of the total escapement can be used as broodtake.
All hatchery origin escapement that is not taken as brood or as ESSR catch continue to spawn.

The broodtake is calculated as the number of spawners required to achieve the target egg production (target releases divided by 85 percent broodtake survival in the hatchery). The ratio of unmarked and marked broodtake matches the target pNOB, which is set to 0.50. 
The age proportions of the broodtake is proportional to the underlying escapement.

In salmonMSE, the effective pNOB is weighted by age class fecundity while the nominal pNOB is calculated from abundance only. 
The realized effective pNOB can differ from the nominal target value for two reasons. 
First, there can be differences in the age distribution of hatchery and natural escapement. For example, hatchery origin fish is younger and less fecund, leading to a higher effective pNOB than the nominal pNOB. 
Second, there may be insufficient natural escapement to achieve the pNOB target.
Currently, a maximum of 50% of the natural escapement can be used as brood.

### Fitness

Hatchery-origin spawners can alter the evolutionary fitness of the spawning population in the natural environment. 
The quantitative genetics component of the model calculates fitness of each brood year based on the parental origin (Ford 2002).
The parameters for the fitness model are primarily informed by Withler et al. (2018).

The population phenotype that is altered by genetic introgression of hatchery spawners is modeled as a Gaussian random variable `z`, with an optimum at 100 in the natural environment and 80 in the hatchery environment. The variance of the phenotype variance ($\sigma^2$) is 10. 

The mean phenotype of a brood year is calculated iteratively from the mean phenotype from parental spawners, accounting for mixed-brood year returns and parental origin, the fitness variance, and the heritability of the phenotype.
Fitness is a cost function calculated from the deviation of the mean phenotype of spawners from the optimum of the natural environment.

The fitness variance ($\omega^2$) is 100, with $\omega^2/\sigma^2 = 10$ implying strong selective pressure. Heritability $h^2$ is stochastic, sampled from a truncated normal distribution with mean of 0.25, standard deviation of 0.15, with bounds of 0 and 0.5.

The equations of Ford (2002) are modified to account for mixed-brood year return, as documented on the [salmonMSE](https://docs.salmonmse.com/articles/equations.html#mixed-brood-year-return) website.

\newpage

```{r sarita-om-bio, results="as-is"}
sarita_table_bio <- readr::read_csv(here::here("tables/sarita-om.csv")) %>%
  filter(grepl("Bio", Type)) %>%
  select(!Type)

csasdown::csas_table(
  sarita_table_bio,
  caption = "Biology, habitat, and harvest parameters organized by life cycle (egg production, freshwater survival, juvenile marine stage, maturity and return). Egg production is calculated from the spawners. Egg-fry survival is density-dependent and stochastic. Outmigrants are separated into two groups which differ in migration timing (before/after April) which impacts survival in the first year."
) %>%
  kableExtra::column_spec(c(1, 2), width = "3in")
```

\newpage

```{r sarita-om-hatchery, results="as-is"}
sarita_table_hatch <- readr::read_csv(here::here("tables/sarita-om.csv")) %>%
  filter(Type == "Hatchery") %>%
  select(!Type)

csasdown::csas_table(
  sarita_table_hatch,
  caption = "Hatchery parameters. The simulated broodtake is back-calculated from target releases, brood survival in hatchery, and fecundity. The brood composition is determined by the target pNOB, subject to a maximum brood-escapement ratio for natural origin fish. Hatchery releases are divided into two groups, fed fry and traditionals, which differ in the timing and size at release. While the survival is identical between release strategeies, traditionals mature earlier than fed fry."
) %>%
  kableExtra::column_spec(c(1, 2), width = "3in")
```

```{r sarita-om-fitness, results="as-is"}
sarita_table_fitness <- readr::read_csv(here::here("tables/sarita-om.csv")) %>%
  filter(Type == "Fitness") %>%
  select(!Type)

csasdown::csas_table(
  sarita_table_fitness,
  caption = "Fitness parameters. Phenotypic traits in a population are modeled as a Gaussian random variable with different optimal values ($\\theta$) for the natural and hatchery environments. The variance of the phenotype $\\sigma^2$$ is identical between environments. The fitness variance ($\\omega^2$) parameterizes the Gaussian cost function of phenotypes from the optimum. The mean phenotype of spawners in the natural environment calculated from the phenotype of the previous generation. If either the proportion of hatchery-origin spawners and the proportion of hatchery origin brood are relatively high, then the mean phenotype is expected to be marginally further from the natural environment optimum. The selection pressure, $\\omega^2/\\sigma^2=10$, describes strong selection pressure with a high cost of being away from the optimum. The heritability $h^2$ can describe the speed at which the system equilibrates."
) %>%
  kableExtra::column_spec(c(1, 2), width = "3in")
```

## Scenarios

A reference grid was developed from three ESSR catch targets (750, 1000, and 1250) and three target pNOB values (0.5, 0.75, and 1.00) in a factorial combination, leading to nine (9) scenarios.

Additional sensitivity scenarios were 

1. Base scenario, as described in Section \@ref(sec:om)
2. 90% Fed Fry – 10% Traditionals, instead of 50-50% in the base
3. 10% Fed Fry – 90% Traditionals
4. High fry/spawner (wet autumns). Assume mean environmental variable of 80% days in October with high daily discharge (compared to 60%)
5. High pNOB target = 0.5 (compared to 0.11)

## Performance metrics

To evaluate and facilitate comparison among alternative management options, the following performance metrics were calculated for the system dynamics at the end of the projection:

1. 
2. 


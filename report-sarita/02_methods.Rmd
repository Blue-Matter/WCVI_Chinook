# Methods

The objectives of the case study are to:

1. Develop an operating model in salmonMSE that incorporates life history variability in hatchery release strategies & natural-origin life cycle groups

2. Develop alternative scenarios to compare outcomes with various habitat and hatchery options

3. Develop performance measures and visualization tools to facilitate comparison of various scenarios

## salmonMSE operating model {#sec:om}

The operating model is stochastic and age-structured. Individual scenarios are projected forward in time from a specified starting abundance.

The configuration of the operating model is presented below and organized by life cycle.
Sources for the parameters include @ctc2023, @brown2025, as well as the exploitation rate models fitted to various CWT datasets (Appendices \@ref(app:sarita-cwt) and \@ref(app:quinsam-cwt)).

The description below represents the base model, from which subsequent alterations are made.
One hundred simulations were used per scenario, with a projection period of 30 years. 

Summary tables of parameters are presented in Tables \@ref(tab:sarita-om-bio) -- \@ref(tab:sarita-om-fitness).

### Spawners

The egg production is calculated from the number of natural origin and hatchery origin spawners. Fecundity is age-specific with fecundity of 3000 at age 3, 3600 at age 4, 4600 at age 5 [@brown2025].

No fish are mature at age 1.

The fecundity at age 2 was set to half of the value of age 3. Most if not all age 2 spawners are precocious males. 
These spawners can ensure genetic diversity by breeding across brood years. 
Since this is not a sex-specific model, some assumption of fecundity value is needed in order to carry over breeding success for age 2 spawners. Calculations involving spawner composition, including pWILD, PNI, and pHOS are weighted by age class fecundity.

Older age classes more predominantly female, where the proportion female is 0.01 at age 2, 0.1 at age 3, 0.55 at age 4, and 0.8 at age 5 [@brown2025].

A typical value of 0.8 was used for the relative reproductive success of hatchery spawners [@withler2018].

### Natural production of juveniles

Egg-fry survival in the natural environment is modeled as a stochastic density-independent parameter, informed by an environment relationship where the fry/adult is predicted from the previous autumn (Figure \@ref(fig:env)).

For the projection, average historical conditions during 2017--2023 were assumed, corresponding to 60% of days when the mean daily discharge exceeded 5 cubic meters per second, the threshold where there is sufficient freshwater flow to allow spawners to reach suitable spawning habitat.
The fry/spawner values were then simulated from a lognormal distribution with the mean and standard deviation obtained in Figure \@ref(fig:env).

The egg-fry survival is converted from fry/spawner assuming an average fecundity of 3,900 and a proportion female of 0.4 (Figure \@ref(fig:fry-surv)). The mean survival is 0.09 with standard deviation of 0.21.

The resulting fry are then divided by life cycle group, which will have different survival rates in age 1, the first year of the marine life stage after outmigration (described in Section \@ref(sec:marine-life-stage)). 
95 percent of the fry as assigned as early-smalls and the rest are late-larges.

(ref:fig-env) Predicted fry per returning adult (line) and 95% confidence interval (grey band) from a log-linear regression of percent of days in October with mean daily discharge on the Sarita River greater than 5 cubic meters per second. Figure was replicated from @brown2025.

```{r env, fig.cap="(ref:fig-env)"}
knitr::include_graphics(here::here("figures/Sarita-fry-survival.png"))
```

(ref:fig-fry-surv) Egg to fry survival sampled stochastically across 3 simulations from the environmental variable. This relationship was derived from the regression in Figure \@ref(fig:env) corresponding to the fry/adult, with average conditions during 2017-2023 of approximately 60% of days with sufficient streamflow for spawning migration. The resulting mean egg-fry survival is 0.09.

```{r fry-surv, fig.cap="(ref:fig-fry-surv)"}
knitr::include_graphics(here::here("figures/Sarita_envvar.png"))
```

### Hatchery production of juveniles

Target hatchery releases, by release strategy, are specified by the user. The releases in 2023 with 292,853 fed fry and 288,745 traditionals were used as the annual target. 
We evaluate hatchery production strategy of 500,000 annual releases with a 50-50 distribution of fed fry and traditionals.

Release strategies differ in maturity rates, described in Section \@ref(sec:maturity).

The mark rate is assumed to be 1.

The mortality rate is 10 percent shortly after release. 
Hatchery releases spend little time in the freshwater environment and immediately enter the marine life stage.

### Marine life stage and preterminal fishery {#sec:marine-life-stage}

The juvenile marine life stage is represented in the model through a matrix that indexes semestral age and time (2 semesters equals one year). 

In the first half of the year, juveniles are vulnerable to the preterminal fishery. 
A constant, annual harvest rate of 0.45 was used. This value is the 2013-2018 mean estimated in the Sarita ERM (Appendix \@ref(app:sarita-cwt)).
Only the oldest age class experiences the full harvest rate. 
Younger age classes experience partial exploitation based on the relative vulnerability.
The vulnerability was estimated in the Sarita ERM and was stochastically sampled from the posterior distribution to create the operating model (Appendix \@ref(app:sarita-cwt)).
It is assumed that the vulnerability schedule is identical for all release strategies and life cycle groups (Figure \@ref(fig:mat-vul)).

In the second half of the year, mature fish are removed from the juvenile abundance matrix, and the remaining juveniles experience natural mortality. 
The natural survival at age 1 natural mortality from obtained from the life cycle model [Table 3.3 of @brown2025], with 96.9% mortality for both hatchery release strategies. For natural origin fish, age-1 natural mortality is 99.6% for early smalls and 95% for late larges. 

For older fish, the natural mortality is 30% at age 2, 20% at age 3, 10% at age 4 and older, as used in @ctc2023.

### Maturity and terminal exploitation {#sec:maturity}

CWT escapement indicate that traditionals mature earlier compared to fed fry.
The maturity at age schedule for traditionals was estimated in the Sarita ERM, which used the Robertson (RBT) Creek hatchery as an indicator stock.
However, unlike the Sarita hatchery, the RBT hatchery comprises of only traditionals.
The data series from the Sarita CWT were too short to be used to estimate maturity.
Therefore, the approach was to estimate maturity of fed fry and traditionals from the Quinsam (northern Strait of Georgia) hatchery, using a separate ERM (Appendix \@ref(app:quinsam-cwt)).
The ratio of the differences in maturity from the Quinsam system were then applied to RBT traditional maturity to propose a maturity schedule for the fed fry (Figure \@ref(fig:mat-vul).

In both the Sarita and Quinsam ERM, the maturity schedule is estimated for each brood year. 
For the operating model, the maturity was stochastically sampled from the posterior and averaged across the most recent 6 complete brood years (2013--2018, Figure \@ref(fig:mat-vul)).

It is assumed that both natural-origin life cycle groups (early-smalls and late-larges) have the maturity schedule of fed fry.

In the operating model, the age structure of the return is represented separately from the juveniles. 
The return are only present in the second half of the year and are vulnerable to the terminal fishery.
The relative vulnerability by age class was stochastically sampled from the posterior distribution in the Sarita ERM (Appendix \@ref(app:sarita-cwt)) and assumed to be identical for all release strategies and life cycle groups (Figure \@ref(fig:mat-vul)).
A constant, annual harvest rate of 0.66 was used. This value is the 2013-2018 mean estimated in the Sarita ERM (Appendix \@ref(app:sarita-cwt)).

```{r mat-vul, out.width="4in", fig.cap="Maturity by hatchery release strategy and fishery vulnerability at age (identical for all fish) in the operating model. Brood-year maturity for traditionals was estimated from Robertson CWT and the average taken during 2013-2018. For fed fry, maturity was derived from analysis of Quinsam CWT. Natural-origin fish have the same maturity as fed fry."}
knitr::include_graphics(here::here("figures/SMSE/maturity_vul.png"))
```

### Escapement

After the terminal fishery, the escapement is represented in a third matrix.
The survival of the escapement en-route to spawning grounds is one.

Each year, an additional 100 hatchery strays, external to the system, also return.
It is assumed that they are unmarked.
The age proportion of strays correspond to values observed in the Sarita CWT for traditionals in 2018, assuming it is representative of strays from adjacent systems (11 percent at age 2, 16% at age 3, 69% at age 4, and 4% at age 5).

The mark-selective ESSR fishery is represented as part of removals for hatchery origin brood.
The annual exploitation rate is specified as the proportion of the hatchery origin escapement that does not go to the spawning ground.
Three alternative ESSR exploitation rates are explored: 0.5, 0.75, and 1.
Natural-origin fish experience no additional mortality from the ESSR fishery.

### Brood

The number of hatchery origin spawners (HOS) is the remaining fish after ESSR removals.
The number of natural origin spawners (NOS) is the remaining fish after additional broodtake.

100 percent of the total escapement can be used as broodtake.
All hatchery origin escapement that is not taken as brood or as ESSR catch continue to spawn.

The broodtake is calculated as the number of spawners required to achieve the target egg production (target releases divided by 85 percent broodtake survival in the hatchery). 
The ratio of unmarked and marked broodtake is taken to reach the target pNOB.
Three target values were explored: 0.5, 0.75, and 1.

Several constraints are placed on the broodtake such that the target pNOB or target egg production may not be realized.
A limit of 50 percent of the natural origin escapement is used as brood to ensure there are sufficient numbers of NOS.
Once that limit is reached, the remaining deficit in hatchery egg production is filled with hatchery origin brood.
The total available hatchery brood is the number from the ESSR fishery.
The age proportions of the brood is proportional to the underlying population, i.e., no preferential broodtake by age class.

### Fitness

Hatchery-origin spawners can alter the evolutionary fitness of the spawning population in the natural environment. 
The quantitative genetics component of the model calculates fitness of each brood year based on the parental origin [@ford2002].
The parameters for the fitness model are primarily informed by @withler2018.

The population phenotype that is altered by genetic introgression of hatchery spawners is modeled as a Gaussian random variable `z`, with an optimum at 100 in the natural environment and 80 in the hatchery environment. The variance of the phenotype variance ($\sigma^2$) is 10. 

The mean phenotype of a brood year is calculated iteratively from the mean phenotype from parental spawners, accounting for mixed-brood year returns and parental origin, the fitness variance, and the heritability of the phenotype.
Fitness is a cost function calculated from the deviation of the mean phenotype of spawners from the optimum of the natural environment.

The fitness variance ($\omega^2$) is 100, with $\omega^2/\sigma^2 = 10$ implying strong selective pressure. Heritability $h^2$ is stochastic, sampled from a truncated normal distribution with mean of 0.25, standard deviation of 0.15, with bounds of 0 and 0.5.

The equations of Ford (2002) are modified to account for mixed-brood year return, as documented on the [salmonMSE](https://docs.salmonmse.com/articles/equations.html#mixed-brood-year-return) website.

\newpage

```{r sarita-om-bio, results="as-is"}
sarita_table_bio <- readr::read_csv(here::here("tables/sarita-om.csv")) %>%
  filter(grepl("Bio", Type)) %>%
  select(!Type)

csasdown::csas_table(
  sarita_table_bio,
  #format = "latex",
  caption = "Biology, habitat, and harvest parameters organized by life cycle (egg production, freshwater survival, juvenile marine stage, maturity and return). Egg production is calculated from the spawners. Egg-fry survival is density-independent and stochastic. Outmigrants are separated into two groups which differ in migration timing (before/after April) which impacts survival in the first year of the marine life stage."
) %>%
  kableExtra::column_spec(1, width = "1.5in") %>%
  kableExtra::column_spec(2, width = "3in")
```

\newpage

```{r sarita-om-hatchery, results="as-is"}
sarita_table_hatch <- readr::read_csv(here::here("tables/sarita-om.csv")) %>%
  filter(Type == "Hatchery") %>%
  select(!Type)

csasdown::csas_table(
  sarita_table_hatch,
  #format = "latex",
  caption = "Hatchery parameters. The simulated broodtake is back-calculated from target releases, brood survival in hatchery, and fecundity. The brood composition is determined by the target pNOB, subject to a maximum brood-escapement ratio for natural origin fish. Hatchery releases are divided into two groups, fed fry and traditionals, which differ in the timing and size at release. While the survival is identical between release strategeies, traditionals mature earlier than fed fry."
) %>%
  kableExtra::column_spec(1, width = "1.5in") %>%
  kableExtra::column_spec(2, width = "3in")
```

```{r sarita-om-fitness, results="as-is"}
sarita_table_fitness <- readr::read_csv(here::here("tables/sarita-om.csv")) %>%
  filter(Type == "Fitness") %>%
  select(!Type)

csasdown::csas_table(
  sarita_table_fitness,
  #format = "latex",
  caption = "Fitness parameters. Phenotypic traits in a population are modeled as a Gaussian random variable with different optimal values ($\\theta$) for the natural and hatchery environments. The phenotype variance $\\sigma^2$ is identical between environments. The fitness variance ($\\omega^2$) parameterizes the Gaussian cost function of phenotypes from the optimum. The mean phenotype of spawners in the natural environment calculated from the phenotype of the previous generation. If either the proportion of hatchery-origin spawners and the proportion of hatchery origin brood are relatively high, then the mean phenotype is expected to be marginally further from the natural environment optimum. The ratio of variance, $\\omega^2/\\sigma^2=10$, describes strong selection pressure with a high penalty for deviating from the optimum. The low  heritability $h^2 < 0.5$ describes the slower rate at which the system equilibrates towards the optimum."
) %>%
  kableExtra::column_spec(2, width = "3in")
```

## Scenarios

A reference grid was developed from a factorial combination of three ESSR exploitation rate targets (0.5, 0.75, and 1) and three target pNOB values (0.5, 0.75, and 1.00) in a factorial combination, leading to nine (9) scenarios.

Additional sensitivity scenarios include:

10. 90% Traditionals - 10% Fed Fry Release Strategy with 500,000 annual releases
11. 90% Fed Fry - 10% Traditionals Release Strategy with 500,000 annual releases
12. High survival (fry/spawner). Assume mean environmental variable with 80% days in October with high daily discharge (compared to 60%), i.e., wetter autumns which may allow eggs to survival to increase as a larger proportion are in suitable freshwater habitat. This results in an average egg-fry survival of 0.18.
13. Density-dependence. Currently no density-dependence is in the reference grid, this additional scenario adds a capacity of 1300 spawners. A hockey-stick relationship is used where the number of spawners is equal to the escapment until the capacity is reached (Figure \@ref(fig:prespawn)). 
14. Declining maturity. The Sarita ERM estimates declining maturity (earlier age of maturity) in recent decades. The reference grid uses a recent mean, but this scenario uses the trend during 1990--2018 and continues the trend into the projection (Figure \@ref(fig:mat-trend)).

Sensitivity scenarios use the ESSR exploitation rate of 0.5 and pNOB target of 0.5.

From the initial abundance estimated in the Sarita ERM at the end of the conditioning period, the population is projected forward for 30 years.
For each scenario, 100 simulation replicates were used to accommodate stochastic parameters.

(ref:fig-prespawn) Schematic function of density-dependent spawner capacity in the sensitivity scenario. A capacity of 1300 spawners is used based on the value of $S_\textrm{rep}$ from @brown2025. A hockey-stick function is used to allow pre-spawn survival of one until the capacity is reached.

```{r prespawn, fig.cap="(ref:fig-prespawn)"}
knitr::include_graphics(here::here("figures/SMSE/prespawn_mortality.png"))
```

(ref:fig-mat-trend) Brood year maturity at age for the traditional release strategy. Historical values prior to 2023 are estimated from the Robertson Creek CWT in the exploitation rate model (ERM). Values between 2019-2023 are not well estimated as complete brood years were not observed in the data. Top: projected values are constant over time using the average over 2013--2018. Bottom: Declining maturity (earlier maturity) where the trend was estimated from the slope of values during 1990--2018 and used to extrapolate into the projection.

```{r mat-trend, fig.cap="(ref:fig-mat-trend)"}
knitr::include_graphics(here::here("figures/SMSE/Sarita_proj_maturity.png"))
```


## Performance metrics

To evaluate and facilitate comparison among alternative management options, various performance metrics were calculated to describe outcomes at the end of the 30-year projection.
These metrics were identified as either primary, to support policy and decision making, and ancillary, to further understand and compare the differences in the system dynamics:

The primary performance metrics are:

- **PNI** proportion natural influence to determine the extent of hatchery influence to the spawning population
- **Total spawners** to determine the overall size of the spawning population
- **P_250** probability that natural spawners exceed the lower benchmark of 250 [@brown2025]
- **P_476** probability that natural spawners exceed the upper benchmark of 476 [@brown2025]
- **pNOBeff** the "effective pNOB" to validate whether the pNOB target can be achieved. The effective pNOB is weighted by age class fecundity while the nominal pNOB used in the target is calculated from abundance only. The realized effective pNOB can differ from the nominal target value for two reasons. 
First, there can be differences in the age distribution of hatchery and natural escapement. For example, hatchery origin fish is younger and less fecund, leading to a higher effective pNOB than the nominal pNOB. Second, there may be insufficient natural escapement to achieve the pNOB target.

The ancillary performance metrics are:

- **pHOSeff** proportion of effective hatchery spawners used to calculate **PNI**
- **pWILD** proportion wild spawners to support Wild Salmon Policy
- **Mean age of spawners** used as an indicator for the presence of older spawners
- **Brood** number of natural and hatchery origin brood used to validate whether the modeled size of the hatchery based on release targets is similar in size to the current hatchery
- **ESSR catch** size of the ESSR catch
- **Escapement** mature fish returning after vulnerability to the terminal fishery
- **Egg** production in the natural environment from NOS and HOS, where trends may differ from the number of spawners due to differences in fecundity at age and time (units of million of eggs)

The median values across simulations are reported, except for **P_250** and **P_476**. 
A summary is provided in Table \@ref(tab:pm).

```{r pm, results="as-is"}
pm <- readr::read_csv(here::here("tables/pm.csv"))

csasdown::csas_table(
  pm,
  #format = "latex",
  caption = "Definitions of performance metrics, either a median or probability calculated across simulations per scenario."
)
```

